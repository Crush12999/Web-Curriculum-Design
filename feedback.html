<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>反馈信息</title>
    <link rel="stylesheet" href="./images/icon/iconfont.css">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/feedback.css">
</head>

<body>
    <div id="app">
        <div id="myMessageBox"></div>
        <!-- 导航栏开始 -->
        <header class="navbar tabsOn">
            <span class="logo-box">
                <img class="logo" src="images/nav_党群档案.svg" alt="">
                <p class="logo-title">庆党百年主题网</p>
            </span>
            <nav class="nav">
                <ul class="nav-links">
                    <li>
                        <a href="index.html">首页</a>
                    </li>
                    <li class="found">
                        <a href="javascript:;">党的光辉历程</a>
                        <ol class="dropdown history">
                            <li><a href="history-1.html">新民主主义革命</a></li>
                            <li><a href="history-2.html">社会主义改造时期</a></li>
                            <li><a href="history-3.html">社会主义建设时期</a></li>
                            <li><a href="history-4.html">中国特色社会主义</a></li>
                        </ol>
                    </li>
                    <li>
                        <a href="hero.html">英雄人物</a>
                    </li>
                    <li>
                        <a href="conference.html">中共大会</a>
                    </li>
                    <li class="found active">
                        <a href="javascript:;">发现更多</a>
                        <ol class="dropdown triangle">
                            <li><a href="videos.html">影视作品</a></li>
                            <li class="active"><a href="feedback.html">反馈</a></li>
                        </ol>
                    </li>
                </ul>
            </nav>
            <span id="user-box" class="user-box" style="display: none;">
                <li>
                    <a href="javascript:;">欢迎，{{ user.username }}</a>
                    <ol class="dropdown">
                        <li><a href="feedback-management.html">留言管理</a></li>
                        <li onclick="logout()"><a href="javascript:;">注销</a></li>
                    </ol>
                </li>
            </span>
            <span id="cta" class="cta">
                <a href="register-login.html"><button>登录 / 注册</button></a>
            </span>
        </header>

        <!-- 导航栏结束 -->

        <!-- 网页主体部分开始 -->
        <main>
            <div class="container">
                <!-- 评论列表 -->
                <div id="feedbackList" class="feedback-list">
                    <!-- 评论信息盒子 -->
                    <div class="feedback-inner">
                        <!-- 头像部分 -->
                        <div class="feedback-avatar">
                            <span>
                                <img src="./images/avatar-girl.svg" alt="">
                            </span>
                        </div>
                        <!-- 评论信息 -->
                        <div class="feedback-content">
                            <!-- 作者信息 -->
                            <div class="feedback-content-author">
                                <span class="feedback-content-author-name">Jenny</span>
                                <span class="feedback-content-author-time">2021-07-08 12:30</span>
                            </div>
                            <!-- 评论内容 -->
                            <div class="feedback-content-detail">
                                <p>加油.</p>
                            </div>
                        </div>
                    </div>
                    <div class="feedback-inner">
                        <!-- 头像部分 -->
                        <div class="feedback-avatar">
                            <span>
                                <img src="./images/avatar-girl.svg" alt="">
                            </span>
                        </div>
                        <!-- 评论信息 -->
                        <div class="feedback-content">
                            <!-- 作者信息 -->
                            <div class="feedback-content-author">
                                <span class="feedback-content-author-name">Aqua99</span>
                                <span class="feedback-content-author-time">2021-07-08 12:30</span>
                            </div>
                            <!-- 评论内容 -->
                            <div class="feedback-content-detail">
                                <p>Come on</p>
                            </div>
                        </div>
                    </div>
                    <div class="feedback-inner">
                        <!-- 头像部分 -->
                        <div class="feedback-avatar">
                            <span>
                                <img src="./images/avatar-boy.svg" alt="">
                            </span>
                        </div>
                        <!-- 评论信息 -->
                        <div class="feedback-content">
                            <!-- 作者信息 -->
                            <div class="feedback-content-author">
                                <span class="feedback-content-author-name">Aqua99</span>
                                <span class="feedback-content-author-time">2021-07-08 12:30</span>
                            </div>
                            <!-- 评论内容 -->
                            <div class="feedback-content-detail">
                                <p>写好了吗</p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 评论提交表单 -->
                <div class="feedback-submit-box" style="width: 100%; padding: 15px 0;">
                    <hr style="border:1px solid red;" />
                    <p style="font-weight: bold; font-size: 26px;margin-top: 15px;">留言板</p>
                    <input id="feedbackName" class="my-input" style="width: 200px;margin-top: 15px;" type="text"
                        :placeholder="user.username" disabled :value="user.username" />
                    <select id="feedbackSex" class="author-sex">
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                    <div class="textarea-limit" style="position: relative; width: 100%;margin-top: 15px;">
                        <textarea maxlength="200" oninput="limitWords()" id="feedbackContent" class="my-input" rows="5"
                            cols="3" placeholder="不要默默地看啦，快点反馈一下吧~"></textarea>
                        <span id="fontLimit"
                            style="position: absolute; bottom: 2px; right: 4px; font-size: 12px;color: #6D6E6A;">
                            0/200
                        </span>
                    </div>

                    <button id="submit-btn" type="button" onclick="submitFeedback()" class="submit-btn">提 交</button>

                </div>
            </div>
        </main>
        <!-- 网页主体部分结束 -->


        <!-- 页脚信息开始 -->
        <footer id="footer" style="padding-top: 15px;">
            <div
                style="background-color: #fff; border-top: 1px solid #e5e6e7;color:#747474; font-size: 14px; height: 48px; text-align: center; line-height: 48px;">
                <span>Copyright © 2020-2021 &nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span>备案号：桂ICP备20xxxx1234号-1</span>
            </div>
        </footer>
        <!-- 页脚信息结束 -->
    </div>


    <script src="./js/lib/vue2.js"></script>
    <script>
        const vm = new Vue({
            el: '#app',
            data: {
                user: {
                    username: '请先登录再留言'
                }
            },
            created: function () {
                this.$nextTick(function () {
                    let flagObj = JSON.parse(localStorage.getItem('onlineUser'))
                    if (flagObj) {
                        this.user = JSON.parse(localStorage.getItem('onlineUser'))
                        document.getElementById('cta').style.display = 'none';
                        document.getElementById('user-box').style.display = 'block';
                    } else {
                        // 登录才允许提交
                        document.getElementById('submit-btn').disabled = true;
                    }
                })
            }
        })
    </script>
    <script>
        function logout() {
            localStorage.setItem('onlineUser', null);
            location.reload()
        }
    </script>

    <script>
        // 日期格式化，挂载到Date原型链
        Date.prototype.format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1,                 //月份
                "d+": this.getDate(),                    //日
                "h+": this.getHours(),                   //小时
                "m+": this.getMinutes(),                 //分
                "s+": this.getSeconds(),                 //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()             //毫秒
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }

        // 评论信息
        let feedbackUser = {
            id: '',
            username: '',
            sex: '',
            time: '',
            msg: ''
        }

        // 反馈信息字数统计
        function limitWords() {
            let myFeedback = document.getElementById('feedbackContent')
            let fontLimit = document.getElementById('fontLimit')
            fontLimit.innerHTML = myFeedback.value.length + '/200';
        }

        // 提交反馈信息
        function submitFeedback() {
            if (checkFeedbackContent()) {
                feedbackUser.username = document.getElementById('feedbackName').value;
                feedbackUser.sex = document.getElementById('feedbackSex').value;
                feedbackUser.msg = document.getElementById('feedbackContent').value;
                feedbackUser.time = new Date().format("yyyy-MM-dd hh:mm:ss");
                let sexImg = (feedbackUser.sex === '男') ? './images/avatar-boy.svg' : './images/avatar-girl.svg';
                let node = document.getElementById('feedbackList');
                str = `<div class="feedback-inner">
                        <div class="feedback-avatar">
                            <span><img src="` + sexImg + `" alt=""></span>
                        </div>
                        <div class="feedback-content">
                            <div class="feedback-content-author">
                                <span class="feedback-content-author-name">` + feedbackUser.username + `</span>
                                <span class="feedback-content-author-time">` + feedbackUser.time + `</span>
                            </div>
                            <div class="feedback-content-detail">
                                <p>` + feedbackUser.msg + `</p>
                            </div>
                        </div>
                    </div>`;
                // 插入到最后一个节点
                node.insertAdjacentHTML('beforeend', str);
                // 解构赋值,选中最后一个结点
                let [parentDoc, childDoc] = [document.querySelector('#feedbackList'), document.querySelector('#feedbackList').lastChild];
                //如果大于div高度使其居中
                // parentDoc.scrollTop = childDoc.offsetTop - parentDoc.offsetHeight / 2;
                // 定位到评论位置
                document.querySelector('.feedback-submit-box').scrollIntoView()
                childDoc.style.background = 'rgba(255, 255, 255, 1)';
                submitDB();
                footerInit();
                setTimeout(() => {
                    childDoc.style.background = '';
                }, 1000)
            } else {
                errorMessageBox('信息不能为空噢~');
            }
        }

        function submitDB() {
            let feedArr = JSON.parse(localStorage.getItem('feedback'));
            if (feedArr) {
                feedbackUser.id = feedArr[feedArr.length - 1].id + 1;
                feedArr.push(feedbackUser);
                localStorage.setItem('feedback', JSON.stringify(feedArr));
            } else {
                feedArr = new Array();
                feedbackUser.id = 1;
                feedArr.push(feedbackUser);
                localStorage.setItem('feedback', JSON.stringify(feedArr));
            }
        }

        function initFeedbackList() {
            feedback = JSON.parse(localStorage.getItem('feedback'));
            if (feedback) {
                for (let i = 0; i < feedback.length; i++) {
                    let sexImg = (feedback[i].sex === '男') ? './images/avatar-boy.svg' : './images/avatar-girl.svg';
                    let node = document.getElementById('feedbackList');
                    str = `<div class="feedback-inner">
                        <div class="feedback-avatar">
                            <span><img src="` + sexImg + `" alt=""></span>
                        </div>
                        <div class="feedback-content">
                            <div class="feedback-content-author">
                                <span class="feedback-content-author-name">` + feedback[i].username + `</span>
                                <span class="feedback-content-author-time">` + feedback[i].time + `</span>
                            </div>
                            <div class="feedback-content-detail">
                                <p>` + feedback[i].msg + `</p>
                            </div>
                        </div>
                    </div>`;
                    // 插入到最后一个节点
                    node.insertAdjacentHTML('beforeend', str);
                    footerInit()
                }
            }
        }


        // 校验留言板反馈信息
        document.getElementById('feedbackContent').addEventListener('blur', checkFeedbackContent)
        function checkFeedbackContent() {
            let content = document.getElementById('feedbackContent').value.replace("/(^\s*)|(\s*$)/g", "");
            if (content.length == 0) {
                document.getElementById('feedbackContent').classList.add('my-input-error');
                return false;
            } else {
                document.getElementById('feedbackContent').classList.remove('my-input-error');
            }
            return true;
        }


        // 错误信息提示
        function errorMessageBox(errorMsg) {
            let str = `<div class="my-message my-message--error">
                    <i class="iconfont icon-fail my-icon-error my-message__icon"></i>
                    <p class="my-message__content">` + errorMsg + `</p>
                </div>`;

            let node = document.getElementById('myMessageBox');
            // node.insertAdjacentHTML('beforeend', str);
            node.innerHTML = str;

            setTimeout(() => {
                node.innerHTML = ''
            }, 3000);
        }

        // 调整网页底部信息栏位置。
        let submitBtnDom = document.querySelector('.submit-btn');
        let footerDom = document.getElementById('footer')
        function footerInit() {
            let viewPort = document.documentElement.clientHeight;
            // 获取评论按钮位置，加上它自身的高度和网页底部高度
            let submitBtnOffsetTop = submitBtnDom.offsetTop + 32 + 15 + 63;
            // 如果评论按钮距离位置小于网页可视高度，则将网页脚部信息固定在网页底部
            if (submitBtnOffsetTop < viewPort) {
                footerDom.classList.add('footer-fixed');
            } else {
                footerDom.classList.remove('footer-fixed');
            }
        }
        window.onload = function () {
            footerInit();
            initFeedbackList();
        }
        window.onresize = function () {
            footerInit();
        }

    </script>
</body>

</html>
