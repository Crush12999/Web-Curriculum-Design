<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./images/icon/iconfont.css">
    <link rel="stylesheet" href="./css/feedback-management.css">
    <title>反馈信息管理</title>
</head>

<body>
    <div id="app">
        <!-- 日历 -->
        <div id="calendar-box" class="calendar-box">
            <div class="cldBody">
                <table>
                    <thead>
                        <tr>
                            <td colspan="7">
                                <div class="top">
                                    <button onclick="prevMonth()" id="left" style="color: #409EFF;">上月</button>
                                    <span id="topDate"></span>
                                    <button onclick="nextMonth()" id="right" style="color: #409EFF;">下月</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="week">
                            <td>日</td>
                            <td>一</td>
                            <td>二</td>
                            <td>三</td>
                            <td>四</td>
                            <td>五</td>
                            <td>六</td>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- 导航栏开始 -->
        <header class="navbar tabsOn">
            <span class="logo-box">
                <img class="logo" src="images/nav_党群档案.svg" alt="">
                <p class="logo-title">庆党百年主题网</p>
            </span>
            <nav class="nav">
                <ul class="nav-links">
                    <li>
                        <a href="index.html">首页</a>
                    </li>
                    <li class="found">
                        <a href="javascript:;">党的光辉历程</a>
                        <ol class="dropdown history">
                            <li><a href="history-1.html">新民主主义革命</a></li>
                            <li><a href="history-2.html">社会主义改造时期</a></li>
                            <li><a href="history-3.html">社会主义建设时期</a></li>
                            <li><a href="history-4.html">中国特色社会主义</a></li>
                        </ol>
                    </li>
                    <li>
                        <a href="hero.html">英雄人物</a>
                    </li>
                    <li>
                        <a href="conference.html">中共大会</a>
                    </li>
                    <li class="found">
                        <a href="javascript:;">发现更多</a>
                        <ol class="dropdown triangle">
                            <li><a href="videos.html">影视作品</a></li>
                            <li><a href="feedback.html">反馈</a></li>
                        </ol>
                    </li>
                </ul>
            </nav>
            <span id="user-box" class="user-box" style="display: none;">
                <li>
                    <a href="javascript:;">欢迎，{{ user.username }}</a>
                    <ol class="dropdown">
                        <li><a href="feedback-management.html">留言管理</a></li>
                        <li onclick="logout()"><a href="javascript:;">注销</a></li>
                    </ol>
                </li>
            </span>
            <span id="cta" class="cta">
                <a href="register-login.html"><button>登录 / 注册</button></a>
            </span>
        </header>
        <!-- 导航栏结束 -->

        <!-- 网页主体开始 -->
        <main>
            <div class="container">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                    <tr>
                        <td align="center" class="biaoti" height="60">反馈信息管理</td>
                    </tr>
                </table>

                <p id="nowTimeText" style="margin-top: 15px; text-align: right;">2021-12-25 17:41:20</p>

                <table width="100%" border="0" cellspacing="1" cellpadding="4" bgcolor="#cccccc" class="tabtop15"
                    align="center">
                    <thead>
                        <tr>
                            <td width="30%" colspan="2" class="btbg font-center titfont">反馈来源</td>
                            <td width="50%" class="btbg font-center titfont" rowspan="2">反馈内容</td>
                            <td width="10%" class="btbg font-center titfont" rowspan="2">操作</td>
                        </tr>
                        <tr>
                            <td width="10%" class="btbg font-center titfont">发布者</td>
                            <td width="20%" class="btbg font-center titfont">时间</td>
                        </tr>
                    </thead>


                    <tbody id="feedbackBox">
                        <tr>
                            <td rowspan="3" class="btbg1 font-center">Aqua99</td>
                            <td class="btbg2 font-center">2021-12-24 22:20:01</td>
                            <td>&nbsp;</td>
                            <td class="font-center">
                                <span class="my-link my-link--danger">删除</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="btbg2 font-center">2021-12-24 22:20:01</td>
                            <td>&nbsp;</td>
                            <td class="font-center">
                                <span class="my-link my-link--danger">删除</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="btbg2 font-center">2021-12-24 22:20:01</td>
                            <td>&nbsp;</td>
                            <td class="font-center">
                                <span class="my-link my-link--danger">删除</span>
                            </td>
                        </tr>
                        <tr>
                            <td rowspan="2" class="btbg1 font-center">admin</td>
                            <td class="btbg2 font-center">2021-12-24 22:20:01</td>
                            <td>&nbsp;</td>
                            <td class="font-center">
                                <span class="my-link my-link--danger">删除</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="btbg2 font-center">2021-12-24 22:20:01</td>
                            <td>&nbsp;</td>
                            <td class="font-center">
                                <span class="my-link my-link--danger">删除</span>
                            </td>
                        </tr>
                    </tbody>

                </table>

                <div id="calendar" style="position: fixed;bottom: 200px; right: 30px;"></div>
            </div>
        </main>
        <button onclick="calendarShow()" class="calendar-btn" id="calendarBtn">日历</button>
        <button onclick="calendarClose()" class="calendar-close" id="calendar-close">关闭</button>

        <!-- 网页主体结束 -->

        <!-- 页脚信息开始 -->
        <footer id="footer" class="" style="padding-top: 15px;">
            <div
                style="background-color: #fff; border-top: 1px solid #e5e6e7;color:#747474; font-size: 14px; height: 48px; text-align: center; line-height: 48px;">
                <span>Copyright © 2020-2021 &nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span>备案号：桂ICP备20xxxx1234号-1</span>
            </div>

        </footer>
        <!-- 页脚信息结束 -->
    </div>

    <script src="./js/lib/vue2.js"></script>

    <script>
        let userObj = JSON.parse(localStorage.getItem('onlineUser'))
        if (userObj) {
            ;
        } else {
            location.href = "index.html"
        }
        // 日期格式化，挂载到Date原型链
        Date.prototype.format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1,                 //月份
                "d+": this.getDate(),                    //日
                "h+": this.getHours(),                   //小时
                "m+": this.getMinutes(),                 //分
                "s+": this.getSeconds(),                 //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()             //毫秒
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }

        function nowTime() {
            document.getElementById('nowTimeText').innerHTML = new Date().format("yyyy-MM-dd hh:mm:ss");
        }

        setInterval("nowTime()", 1000)

        // 调整网页底部信息栏位置。
        let footerDom = document.querySelector('#footer');
        function footerInit() {
            let viewPort = document.documentElement.clientHeight;
            let footerOffsetTop = footerDom.offsetTop;
            // 如果元素距离顶部高度加上它自身的高度小于网页可视高度，则将其固定在网页底部
            if (footerOffsetTop + footerDom.style.height < viewPort) {
                footerDom.classList.add('footer-fixed');
            } else {
                footerDom.classList.remove('footer-fixed');
            }
        }

        window.onload = footerInit()

        // 删除留言
        function deleteFeedback(id) {
            let feedbackList = localStorage.getItem('feedback')
                ? JSON.parse(localStorage.getItem('feedback'))
                : '';

            for (let i = 0; i < feedbackList.length; i++) {
                if (feedbackList[i].id === id) {
                    feedbackList.splice(i, 1);
                    break;
                }
            }
            localStorage.setItem('feedback', JSON.stringify(feedbackList));
            // 初始化表格数据
            initTableData()
        }

        // 初始化表格数据方法
        function initTableData() {
            let data = initLocalData();
            let feedbackDom = document.getElementById('feedbackBox');
            let feedbackHtml = ''
            // 遍历map容器
            data.forEach((value, key, map) => {
                for (let i = 0, flag = true; i < value.length; i++) {
                    feedbackHtml += '<tr>';
                    if (flag) {
                        feedbackHtml += `<td class="btbg1 font-center" rowspan="${value.length}">${key}</td>`;
                        flag = false;
                    }
                    feedbackHtml += `<td class="btbg2 font-center">${value[i].time}</td>`;
                    feedbackHtml += `<td class="font-center">${value[i].msg}</td>`;
                    feedbackHtml += `<td class="font-center"><span class="my-link my-link--danger" onclick="deleteFeedback(${value[i].id} )"><i class="iconfont icon-delete"></i>&nbsp;删除</span></td>`;
                    feedbackHtml += '</tr>';
                }
            })

            feedbackDom.innerHTML = feedbackHtml
        }
        initTableData()


        // 处理localStorage存储的数据，整理成map结构，用户名映射反馈的信息列表
        function initLocalData() {
            let feedbackList = localStorage.getItem('feedback')
                ? JSON.parse(localStorage.getItem('feedback'))
                : '';
            let userMap = new Map();
            for (let i = 0; i < feedbackList.length; i++) {
                if (userMap.get(feedbackList[i].username)) {
                    userMap.get(feedbackList[i].username).push(feedbackList[i]);
                } else {
                    userMap.set(feedbackList[i].username, [])
                    userMap.get(feedbackList[i].username).push(feedbackList[i]);
                }
            }
            return userMap;
        }

        function logout() {
            localStorage.setItem('onlineUser', null);
            location.href = "index.html"
        }


        // 日历
        var date = new Date();
        var year = date.getFullYear();
        var nowyear = date.getFullYear();
        var month = date.getMonth() + 1;
        var nowmonth = date.getMonth() + 1;
        var dateday = date.getDate();
        var todateHtml = year + '年' + month + '月';
        document.getElementById('topDate').innerHTML = todateHtml
        function showcld() {
            var monthDay = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];  // 创建数组存放每个月有多少天 ,默认2月为28天
            // 判断闰年
            if (year % 4 == 0 && year % 100 != 0 || year % 400 == 0) {
                monthDay[1] = 29;
            }
            // 计算每个月的天数
            var days = monthDay[month - 1];
            // 判断每月第一天为周几
            date.setYear(year);        //某年
            date.setMonth(month - 1);   //某年的某月
            date.setDate(1);   // 某月的某天
            var weekday = date.getDay();  // 判断某天是周几
            // 补齐一号前的空格
            var tbodyHtml = '<tr>';
            for (var i = 0; i < weekday; i++) {
                tbodyHtml += "<td></td>";
            }
            // 补齐每月的日期
            var changLine = weekday;
            var tagClass = '';
            for (i = 1; i <= days; i++) {//每一个日期的填充
                if (year == nowyear && month == nowmonth && i == dateday) {
                    tagClass = "curDate";//当前日期对应格子
                } else {
                    tagClass = "isDate";
                }
                tbodyHtml += "<td class=" + tagClass + ">" + i + "</td>";
                changLine = (changLine + 1) % 7;
                if (changLine == 0 && i != days) {//是否换行填充的判断
                    tbodyHtml += "</tr><tr>";
                }
            }
            document.getElementById('tbody').innerHTML = '';
            document.getElementById('tbody').innerHTML += tbodyHtml
        }

        // 设置按钮点击事件
        function prevMonth() {
            month = month - 1;
            if (month < 1) {
                month = 12;
                year--;
            }
            var todateHtml = year + '年' + month + '月';
            document.getElementById('topDate').innerHTML = todateHtml
            showcld();
        }

        function nextMonth() {
            month = month + 1;
            if (month > 12) {
                month = 1;
                year++;
            }
            var todateHtml = year + '年' + month + '月';
            document.getElementById('topDate').innerHTML = todateHtml
            showcld();
        }


        function calendarShow() {
            document.getElementById('calendarBtn').style.display = 'none';
            document.getElementById('calendar-box').style.display = 'block';
            document.getElementById('calendar-close').style.display = 'block';
            document.getElementById('calendar-close').style.zIndex = 9999;
            showcld();
        }

        function calendarClose() {
            document.getElementById('calendarBtn').style.display = 'block';
            document.getElementById('calendar-box').style.display = 'none';
            document.getElementById('calendar-close').style.display = 'none';
        }
    </script>

    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                activeIndex: '1',
                user: ''
            },
            created: function () {
                this.$nextTick(function () {
                    this.user = JSON.parse(localStorage.getItem('onlineUser'))
                    if (this.user && this.user != null) {
                        document.getElementById('cta').style.display = 'none';
                        document.getElementById('user-box').style.display = 'block';
                    }
                })
            }
        })
    </script>


</body>

</html>
